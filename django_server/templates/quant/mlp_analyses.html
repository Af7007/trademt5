{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MLP Análises - Sistema Quantitativo</title>

    <!-- Bootstrap para interface profissional -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .card { margin-bottom: 20px; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-header { background-color: #f8f9fa; font-weight: 600; border-bottom: 1px solid #e9ecef; }
        .metric-card .card-body { padding: 1.5rem; text-align: center; }
        .metric-value { font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem; }
        .metric-label { color: #6c757d; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .chart-container { position: relative; height: 300px; margin-bottom: 20px; }
        .navbar-brand { font-weight: 700; }
        .btn-primary { background-color: #0d6efd; border-color: #0d6efd; }
        .table-responsive { margin-top: 1rem; }
        .status-success { color: #198754; }
        .status-warning { color: #ffc107; }
        .status-danger { color: #dc3545; }
        .badge { font-size: 0.75em; }
        body { background-color: #f8f9fa; }
        .container-fluid { padding: 1.5rem; }
        .shadow-sm { box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075)!important; }
        .fs-7 { font-size: 0.8rem; }
        .text-truncate { max-width: 200px; }
        .progress { height: 8px; }
        .small { font-size: 0.875em; }
        .analysis-card { transition: all 0.3s ease; }
        .analysis-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    </style>
</head>
<body>
    <!-- Navbar Superior -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4 shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-cpu-fill me-2"></i>MLP Análises
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'quant:mlp_dashboard' %}">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{% url 'quant:mlp_analyses' %}">Análises</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'quant:mlp_trades' %}">Trades</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-outline-light ms-2" href="{% url 'quant:mlp_control' %}">
                            <i class="bi bi-joystick me-1"></i>Controle
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="navbar-text">
                            <i class="bi bi-brain me-1"></i>{{ current_time|date:"d/m H:i" }}
                        </span>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Header com filtros -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="bi bi-gear-fill text-primary me-2"></i>Filtros de Análises
                            </h4>
                            <div class="btn-group btn-group-sm" role="group">
                                <input type="radio" class="btn-check" name="timeRange" id="last24h" autocomplete="off" checked>
                                <label class="btn btn-outline-primary btn-sm" for="last24h">
                                    <i class="bi bi-clock me-1"></i>24h
                                </label>
                                <input type="radio" class="btn-check" name="timeRange" id="last7d" autocomplete="off">
                                <label class="btn btn-outline-primary btn-sm" for="last7d">
                                    <i class="bi bi-calendar-week me-1"></i>7d
                                </label>
                                <input type="radio" class="btn-check" name="timeRange" id="last30d" autocomplete="off">
                                <label class="btn btn-outline-primary btn-sm" for="last30d">
                                    <i class="bi bi-calendar-month me-1"></i>30d
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label">Símbolo</label>
                                <select class="form-select" id="symbolFilter">
                                    <option value="all" selected>TODOS</option>
                                    <option value="BTCUSDc">BTCUSD</option>
                                    <option value="EURUSD">EURUSD</option>
                                    <option value="GBPUSD">GBPUSD</option>
                                    <option value="USDJPY">USDJPY</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label">Sinal</label>
                                <select class="form-select" id="signalFilter">
                                    <option value="all" selected>TODOS</option>
                                    <option value="BUY">BUY</option>
                                    <option value="SELL">SELL</option>
                                    <option value="HOLD">HOLD</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label">Confiança Mínima</label>
                                <select class="form-select" id="confidenceFilter">
                                    <option value="0" selected>Todas</option>
                                    <option value="50">50%</option>
                                    <option value="70">70%</option>
                                    <option value="85">85%</option>
                                    <option value="95">95%</option>
                                </select>
                            </div>
                            <div class="col-lg-3 col-md-6 mb-3">
                                <label class="form-label">Status</label>
                                <select class="form-select" id="statusFilter">
                                    <option value="all" selected>TODOS</option>
                                    <option value="executed">Executado</option>
                                    <option value="pending">Pendente</option>
                                    <option value="cancelled">Cancelado</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Análises Grid -->
        <div class="row mb-4">
            {% if recent_analyses %}
                {% for analysis in recent_analyses %}
                <div class="col-lg-6 col-xl-4 mb-4 analysis-item" data-symbol="{{ analysis.symbol }}" data-signal="{{ analysis.signal }}" data-confidence="{{ analysis.confidence }}">
                    <div class="card analysis-card h-100">
                        <div class="card-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">
                                        <i class="bi bi-currency-bitcoin me-1"></i>{{ analysis.symbol }}
                                    </h6>
                                    <small class="text-muted">{{ analysis.timestamp|date:"d/m H:i:s" }}</small>
                                </div>
                                <div class="text-end">
                                    <span class="badge fs-7 bg-primary">{{ analysis.signal }}</span>
                                    <div class="text-primary fw-bold mt-1">{{ analysis.confidence|floatformat:1 }}%</div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Indicadores técnicos -->
                            <div class="row text-center g-2 mb-3">
                                <div class="col-4">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">RSI</small>
                                        <div class="fw-bold text-primary">{{ analysis.rsi|floatformat:1 }}</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">MACD</small>
                                        <div class="fw-bold text-success">{{ analysis.macd_signal|floatformat:4 }}</div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="border rounded p-2">
                                        <small class="text-muted d-block">Bollinger</small>
                                        <div class="small fw-bold">
                                            {{ analysis.bb_upper|floatformat:0 }}<br/>
                                            <span class="fw-normal">/</span>
                                            {{ analysis.bb_lower|floatformat:0 }}
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Status do trade relacionado -->
                            <div class="mt-3">
                                <small class="text-muted d-block mb-2">Status do Trade:</small>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success-subtle text-success me-2">
                                        <i class="bi bi-check-circle-fill me-1"></i>Executado
                                    </span>
                                    <small class="text-muted">
                                        ID Trade: {{ analysis.id }}
                                    </small>
                                </div>
                            </div>

                            <!-- Ações -->
                            <div class="mt-3">
                                <div class="btn-group w-100" role="group">
                                    <button type="button" class="btn btn-outline-primary btn-sm">
                                        <i class="bi bi-eye me-1"></i>Detalhes
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm">
                                        <i class="bi bi-cart-plus me-1"></i>Executar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="card">
                        <div class="card-body text-center py-5">
                            <i class="bi bi-graph-up text-info fs-1 mb-3"></i>
                            <h4>Nenhuma análise encontrada</h4>
                            <p class="text-muted">As análises MLP aparecerão aqui quando o sistema começar a funcionar.</p>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Estatísticas das análises -->
        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-bar-chart-line-fill text-primary me-2"></i>Performance das Análises - Últimos 7 Dias
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="analysisChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-trophy-fill text-warning me-2"></i>Top Análises
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="max-height: 300px; overflow-y: auto;">
                            {% if recent_analyses %}
                                {% for analysis in recent_analyses|slice:":5" %}
                                <div class="border-start border-primary border-3 ps-3 mb-3">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <span class="fw-bold small">{{ analysis.symbol }}</span>
                                        <span class="badge fs-7 bg-primary">{{ analysis.confidence|floatformat:1 }}%</span>
                                    </div>
                                    <div class="small text-muted">{{ analysis.timestamp|date:"d/m H:i" }}</div>
                                    <div class="small fw-bold text-primary">
                                        {{ analysis.signal }}
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-muted text-center py-3">Sem dados disponíveis</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabela detalhada -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-table text-info me-2"></i>Histórico Detalhado de Análises
                            </h5>
                            <div class="btn-group btn-group-sm" role="group">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="exportToCSV()">
                                    <i class="bi bi-download me-1"></i>Exportar CSV
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>Símbolo</th>
                                        <th>Sinal</th>
                                        <th>Confiança</th>
                                        <th>RSI</th>
                                        <th>MACD</th>
                                        <th>Bollinger</th>
                                        <th>Status</th>
                                        <th>Preço</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recent_analyses %}
                                        {% for analysis in recent_analyses %}
                                        <tr>
                                            <td class="small">{{ analysis.timestamp|date:"d/m/y H:i" }}</td>
                                            <td><span class="badge bg-secondary">{{ analysis.symbol }}</span></td>
                                            <td>
                                                <span class="badge fs-7 bg-primary">
                                                    {{ analysis.signal }}
                                                </span>
                                            </td>
                                            <td class="fw-bold">{{ analysis.confidence|floatformat:1 }}%</td>
                                            <td>{{ analysis.rsi|floatformat:1 }}</td>
                                            <td class="small">{{ analysis.macd_signal|floatformat:4 }}</td>
                                            <td class="small">{{ analysis.bb_upper|floatformat:2 }}/{{ analysis.bb_lower|floatformat:2 }}</td>
                                            <td><span class="badge bg-success-subtle text-success">Executado</span></td>
                                            <td class="text-end">
                                                {% if analysis.symbol == 'BTCUSDc' %}
                                                    ~$65,200
                                                {% else %}
                                                    {% if analysis.symbol == 'EURUSD' %}
                                                        ~1.0850
                                                    {% else %}
                                                        ~150,000
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="9" class="text-center text-muted py-4">
                                                <i class="bi bi-info-circle fs-2 mb-2"></i>
                                                <div>Nenhuma análise para exibir</div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginação -->
                        {% if recent_analyses and recent_analyses|length > 10 %}
                        <nav aria-label="Paginação" class="mt-3">
                            <ul class="pagination justify-content-center">
                                <li class="page-item disabled">
                                    <a class="page-link" href="#" tabindex="-1">Anterior</a>
                                </li>
                                <li class="page-item active">
                                    <a class="page-link" href="#">1</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#">2</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#">3</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#">Próximo</a>
                                </li>
                            </ul>
                        </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Dados simulados para demonstração
        const analysesData = [
            {% for analysis in recent_analyses %}
            {
                id: {{ analysis.id }},
                symbol: "{{ analysis.symbol }}",
                signal: "{{ analysis.signal }}",
                confidence: {{ analysis.confidence }},
                rsi: {{ analysis.rsi }},
                macd_signal: {{ analysis.macd_signal }},
                bb_upper: {{ analysis.bb_upper }},
                bb_lower: {{ analysis.bb_lower }},
                timestamp: "{{ analysis.timestamp }}"
            }{% if not forloop.last %},{% endif %}
            {% endfor %}
        ];

        // Funcionalidade de filtros
        document.addEventListener('DOMContentLoaded', function() {
            const filters = document.querySelectorAll('select[id$="Filter"]');
            filters.forEach(filter => {
                filter.addEventListener('change', applyFilters);
            });

            // Inicializar gráficos
            initializeCharts();
        });

        function applyFilters() {
            const symbolFilter = document.getElementById('symbolFilter').value;
            const signalFilter = document.getElementById('signalFilter').value;
            const confidenceFilter = parseFloat(document.getElementById('confidenceFilter').value);
            const statusFilter = document.getElementById('statusFilter').value;

            const analysisItems = document.querySelectorAll('.analysis-item');

            analysisItems.forEach(item => {
                let show = true;

                // Filtro por símbolo
                if (symbolFilter !== 'all' && item.dataset.symbol !== symbolFilter) {
                    show = false;
                }

                // Filtro por sinal
                if (signalFilter !== 'all' && item.dataset.signal !== signalFilter) {
                    show = false;
                }

                // Filtro por confiança
                if (confidenceFilter > 0 && parseFloat(item.dataset.confidence) < confidenceFilter) {
                    show = false;
                }

                // Filtro por status
                if (statusFilter !== 'all') {
                    // Para demonstração, todos são considerados "executed"
                    if (statusFilter !== 'executed') {
                        show = false;
                    }
                }

                item.style.display = show ? 'block' : 'none';
            });
        }

        function initializeCharts() {
            // Análise chart
            const ctx = document.getElementById('analysisChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Dia 1', 'Dia 2', 'Dia 3', 'Dia 4', 'Dia 5', 'Dia 6', 'Dia 7'],
                        datasets: [{
                            label: 'Taxa de Acerto',
                            data: [68, 72, 65, 78, 75, 69, 71],
                            borderColor: 'rgb(13, 110, 253)',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            tension: 0.1
                        }, {
                            label: 'Confiança Média',
                            data: [76, 79, 73, 82, 78, 75, 77],
                            borderColor: 'rgb(25, 135, 84)',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value + '%';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }

        function exportToCSV() {
            // Simulação de export CSV
            alert('Funcionalidade de export CSV seria implementada aqui');
        }
    </script>
</body>
</html>
